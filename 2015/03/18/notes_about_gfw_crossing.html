<!DOCTYPE html>
<html>
<head>
	<meta charset=utf-8 />
	<title>科学上网笔记</title>
	<!--<link rel="stylesheet" type="text/css" media="screen" href="css/master.css" />-->
	<!--<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>-->
	<!--<link rel="stylesheet" href="http://tom.preston-werner.com/css/syntax.css" type="text/css" />-->
	<!--<link rel="stylesheet" href="/s/c/bootstrap-2.0.4.css" type="text/css" />-->
	<link rel="stylesheet" href="/s/c/app.css" type="text/css" />
</head>
<body>
  <div class="hp-pgwr">
    <header>
      <a class="hp-site_head" href="/">Meow and Grrr of a Stray Cat</a>
      <p class="hp-site_subhead">Life, opinions, tech notes, etc.</p>
    </header>
    
    <nav class="hp-mnav">
      <a class="hp-li hp-on" href="/">posts</a>
      <a class="hp-li" href="/gallery/">gallery</a>
      <a class="hp-li" href="http://snow.github.com/resume" target="_blank">resume</a>
    </nav>
    
    <div class="hp-pgbd">
      <div class="hp-inr"><div class="hp-ma">
  <div class="hp-pg-post">
    <article>
      <h1>科学上网笔记</h1>

<h2>我们面对什么问题</h2>

<ol>
<li>国内的 dns 可能把某些域名解析到错误的 ip 上，或者不解析. (search about &ldquo;DNS污染&rdquo;)</li>
<li>对某些 ip 的访问可能被阻断.</li>
<li>对某些 ip 的访问可能被丢包.</li>
<li>国际出口非常非常非常拥堵. (需证实)</li>
</ol>

<h2>逐个设法解决</h2>

<!-- more -->

<h3>DNS</h3>

<h4>改用干净的DNS</h4>

<ul>
<li>8.8.8.8 # Google </li>
<li>8.8.4.4 </li>
<li>208.67.222.222 # open dns</li>
<li>208.67.220.220</li>
<li>77.88.8.8 # yandex</li>
<li>77.88.8.1</li>
</ul>

<p>不幸的是，这些 ip 也被干扰了，导致有时候无法解析域名。</p>

<h4>加密 dns 查询</h4>

<p>为了做加密的dns查询，需要</p>

<ul>
<li>一台可以信任的并且支持dnscrypt的dns服务器</li>
<li>在本机配置dnscrypt</li>
</ul>

<p>首先是dns服务. 支持 dnscrypt 的服务器清单在 <a href="https://github.com/jedisct1/dnscrypt-proxy/blob/master/dnscrypt-resolvers.csv">https://github.com/jedisct1/dnscrypt-proxy/blob/master/dnscrypt-resolvers.csv</a> , 不幸的是，这个清单上没有合适国内用的选项。<br>
所以我们只好首先在墙外租一台服务器，然后在上面安装 dnscrypt-wrapper <a href="http://cofyc.github.io/dnscrypt-wrapper/">http://cofyc.github.io/dnscrypt-wrapper/</a> 来把dns请求转交给墙外的公共dns服务。</p>

<p>然后在本机<code>brew install dnscrypt-proxy</code>, 按brew的安装说明完成剩下的步骤，然后编辑 <code>/Library/LaunchDaemons/homebrew.mxcl.dnscrypt-proxy.plist</code>:</p>
<div class="highlight"><pre><span class="nt">&lt;array&gt;</span>
  <span class="nt">&lt;string&gt;</span>/usr/local/opt/dnscrypt-proxy/sbin/dnscrypt-proxy<span class="nt">&lt;/string&gt;</span>
  <span class="nt">&lt;string&gt;</span>--user=nobody<span class="nt">&lt;/string&gt;</span>
  <span class="nt">&lt;string&gt;</span>--resolver-address=x.x.x.x:x<span class="nt">&lt;/string&gt;</span>
  <span class="nt">&lt;string&gt;</span>--provider-key=xxx<span class="nt">&lt;/string&gt;</span>
  <span class="nt">&lt;string&gt;</span>--provider-name=xxx<span class="nt">&lt;/string&gt;</span>
  <span class="nt">&lt;string&gt;</span>--local-address=127.0.0.1:40<span class="nt">&lt;/string&gt;</span>
<span class="nt">&lt;/array&gt;</span>
</pre></div>
<p>如果需要，sudo launchctl unload/load一遍来让设置生效。</p>

<p>不幸的是，每个dns请求都要走一遍隧道的话很慢。</p>

<h4>DNS缓存</h4>

<p>用unbound来缓存dns查询，并把请求分发到多个dns服务器来碰碰运气看有没有哪个dns速度好能改善一下性能。
用brew安装配置好unbound之后，编辑<code>/usr/local/etc/unbound/unbound.conf</code>, 在末尾加上</p>
<div class="highlight"><pre><span class="l-Scalar-Plain">forward-zone</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;.&quot;</span>
  <span class="l-Scalar-Plain">forward-addr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">127.0.0.1@40</span>
  <span class="l-Scalar-Plain">forward-addr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8.8.8.8</span>
  <span class="l-Scalar-Plain">forward-addr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8.8.4.4</span>
  <span class="l-Scalar-Plain">forward-addr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">208.67.222.222</span>
  <span class="l-Scalar-Plain">forward-addr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">208.67.220.220</span>
  <span class="l-Scalar-Plain">forward-addr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">77.88.8.8</span>
  <span class="l-Scalar-Plain">forward-addr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">77.88.8.1</span>
</pre></div><div class="highlight"><pre><span class="n">hsh</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">a</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">b</span><span class="p">:</span> <span class="mi">2</span> <span class="p">}</span><span class="o">.</span><span class="n">tap</span> <span class="p">{</span> <span class="o">|</span><span class="n">h</span><span class="o">|</span>
  <span class="n">h</span><span class="o">[</span><span class="ss">:c</span><span class="o">]</span> <span class="o">=</span> <span class="mi">3</span>
<span class="p">}</span>
</pre></div>
<p>unload/load之后修改网络设置，设置127.0.0.1为唯一的dns服务器。</p>

<h3>流量隧道</h3>

<p>目前用着还不错的隧道有</p>

<ul>
<li>曲径的http proxy, 提取方法我不想写在这里。</li>
<li>国外买vps自建shadowsocks</li>
</ul>

<h3>浏览器</h3>

<p>Chrome + swtichy omega, 平时会上的国内网站不超过五个，白名单处理，默认走隧道。</p>

<h3>命令行和其它应用</h3>

<p>proxychains (<a href="https://github.com/rofl0r/proxychains-ng">https://github.com/rofl0r/proxychains-ng</a>) 在ssh上效果相当好</p>

      
      <footer>posted at 2015-03-18 01:23:00 +0800</footer>
    </article>
  </div>
</div>

<div class="hp-sb">
  <section class="hp-author">
  <header>The author</header>
  <h2>Snow Hellsing</h2>
  Just a stray cat
</section>
  
  <section class="hp-tags">
    <header>Tagged in</header>
    
    <a href="/tags/gfw.html">gfw</a>
    
    <a href="/tags/tech.html">tech</a>
    
  </section>
</div>



        <div class="hp-c"></div>
      </div>
    </div>
    
    <footer>Powered by <a href="http://jekyllrb.com/" target="_blank">jekyll</a>, hosting on <a href="http://pages.github.com/" target="_blank">github</a></footer>
  </div>
</body>
</html>
