<!DOCTYPE html>
<html>
<head>
	<meta charset=utf-8 />
	<title></title>
	<!--<link rel="stylesheet" type="text/css" media="screen" href="css/master.css" />-->
	<!--<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>-->
	<!--<link rel="stylesheet" href="http://tom.preston-werner.com/css/syntax.css" type="text/css" />-->
	<!--<link rel="stylesheet" href="/s/c/bootstrap-2.0.4.css" type="text/css" />-->
	<link rel="stylesheet" href="/s/c/app.css" type="text/css" />
</head>
<body>
  <div class="hp-pgwr">
    <header>
      <a class="hp-site_head" href="/">Meow and Grrr of a Stray Cat</a>
      <p class="hp-site_subhead">Life, opinions, tech notes, etc.</p>
    </header>
    
    <nav class="hp-mnav">
      <a class="hp-li hp-on" href="/">posts</a>
      <a class="hp-li" href="/gallery/">gallery</a>
      <a class="hp-li" href="http://snow.github.com/resume" target="_blank">resume</a>
    </nav>
    
    <div class="hp-pgbd">
      <div class="hp-inr"><div class="hp-ma">
  <div class="hp-pg-tag_index">
  <h1 class="hp-pg_head">Tag: mysql</h1>
  <div class="hp-block_stream">
    
      <a class="hp-block_si" href="/2013/03/13/many_to_many_association_query_performance_test_with_rails_and_mysql.html"><h1>Many-to-many Association Query Performance Test with Rails and Mysql</h1>

<h2>the question</h2>

<p>given two models with many-to-many association, say, Item and Tag, to query items with one or more tags, there are three ways at least.</p>

<p>say condition is tags [1, 2, 3]</p>

<p><strong>use join</strong>
<code>SQL
SELECT `items`.* FROM `items` 
  INNER JOIN `items_tags` ON `items`.`id` = `items_tags`.`item_id` 
  WHERE `items_tags`.`tag_id` in (1, 2, 3);
</code></p>

<p><strong>use in</strong>
<code>SQL
select * from items
  where id in (select item_id from items_tags where tag_id in (1, 2, 3))
</code></p>

<p><strong>use exists</strong>
<code>SQL
select * from items where exists (select 1 from items_tags where tag_id in (1, 2, 3))
</code></p>

<p>pros and cons for each?</p>

<h2>the test</h2>

<h3>migrations</h3>
<div class="highlight"><pre><span class="n">create_table</span> <span class="ss">:tags</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">limit</span><span class="p">:</span> <span class="mi">255</span>
  <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
<span class="k">end</span>

<span class="n">create_table</span> <span class="ss">:items</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
<span class="k">end</span>

<span class="n">create_table</span> <span class="ss">:items_tags</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="o">.</span><span class="n">column</span> <span class="ss">:item_id</span><span class="p">,</span> <span class="s1">&#39;int unsigned&#39;</span><span class="p">,</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span>
  <span class="n">t</span><span class="o">.</span><span class="n">column</span> <span class="ss">:tag_id</span><span class="p">,</span> <span class="s1">&#39;int unsigned&#39;</span><span class="p">,</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span>
<span class="k">end</span>

<span class="n">add_index</span> <span class="ss">:items_tags</span><span class="p">,</span> <span class="o">[</span><span class="ss">:item_id</span><span class="p">,</span> <span class="ss">:tag_id</span><span class="o">]</span><span class="p">,</span> <span class="ss">unique</span><span class="p">:</span> <span class="kp">true</span>
</pre></div>
<h3>db/seed</h3>
<div class="highlight"><pre><span class="k">while</span> <span class="no">Tag</span><span class="o">.</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">100</span> <span class="k">do</span>
  <span class="no">Tag</span><span class="o">.</span><span class="n">create!</span> <span class="nb">name</span><span class="p">:</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Lorem</span><span class="o">.</span><span class="n">word</span>
<span class="k">end</span>

<span class="k">while</span> <span class="no">Item</span><span class="o">.</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">100_000</span> <span class="k">do</span>
  <span class="no">Item</span><span class="o">.</span><span class="n">create!</span>
<span class="k">end</span>

<span class="no">Item</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s1">&#39;not exists (select 1 from items_tags where item_id = items.id)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
  <span class="n">item</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="no">Tag</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s1">&#39;rand()&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="nb">rand</span> <span class="mi">3</span><span class="o">.</span><span class="n">.</span><span class="mi">7</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
<h3>run the sql in console</h3>

<p>paste sql in mysql console and run them for couple of times, the &lsquo;join&rsquo; way and &#39;in&rsquo; way use 3xx ms, the &#39;exists&rsquo; way use 5xx~6xx ms.</p>

<h3>benchmark script</h3>

<p>use script for automatic test, but the test introduced a lot of cost in framework. not important for comparison though</p>
<div class="highlight"><pre><span class="no">TIMES_RUN</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">tag_ids</span> <span class="o">=</span> <span class="no">Tag</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s1">&#39;rand()&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
<span class="n">tag_id_str</span> <span class="o">=</span> <span class="n">tag_ids</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

<span class="no">Benchmark</span><span class="o">.</span><span class="n">bmbm</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
  <span class="n">x</span><span class="o">.</span><span class="n">report</span> <span class="ss">:join</span> <span class="k">do</span>
    <span class="no">TIMES_RUN</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
      <span class="no">Item</span><span class="o">.</span><span class="n">find_by_sql</span><span class="p">(</span><span class="s1">&#39;SELECT `items`.* FROM `items` &#39;</span><span class="p">\</span>
                       <span class="s1">&#39;INNER JOIN `items_tags` ON `items`.`id` = `items_tags`.`item_id` &#39;</span><span class="p">\</span>
                       <span class="s2">&quot;WHERE `items_tags`.`tag_id` in (</span><span class="si">#{</span><span class="n">tag_id_str</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">x</span><span class="o">.</span><span class="n">report</span> <span class="ss">:in</span> <span class="k">do</span>
    <span class="no">TIMES_RUN</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
      <span class="no">Item</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s1">&#39;id in (select item_id from items_tags where tag_id in (?))&#39;</span><span class="p">,</span> <span class="n">tag_ids</span><span class="p">)</span><span class="o">.</span><span class="n">all</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">x</span><span class="o">.</span><span class="n">report</span> <span class="ss">:exists</span> <span class="k">do</span>
    <span class="no">TIMES_RUN</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
      <span class="no">Item</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s1">&#39;exists (select 1 from items_tags where tag_id in (?))&#39;</span><span class="p">,</span> <span class="n">tag_ids</span><span class="p">)</span><span class="o">.</span><span class="n">all</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
<h3>result</h3>

<p>Rehearsal &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;
join   114.580000   0.960000 115.540000 (149.312769)
in     109.510000   0.860000 110.370000 (144.324412)
exists 924.210000   5.810000 930.020000 (932.987542)
&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash; total: 1155.930000sec</p>
<div class="highlight"><pre><span class="w">         </span><span class="vg">user</span><span class="w">     </span><span class="vg">system</span><span class="w">      </span><span class="vg">total</span><span class="w">        </span><span class="vg">real</span>
</pre></div>
<p>join    99.540000   0.760000 100.300000 (133.294855)
in      94.630000   0.780000  95.410000 (127.911915)
exists 801.930000   5.330000 807.260000 (812.346172)</p>

<h3>and?</h3>

<p>I&rsquo;m gonna make the test more similar to the scnario in real production: frontend post a comma separated string of tag names, and the controller pass it to model, model split the string by &rsquo;,&rsquo;, query with tag name array, and return record list.
this test will drop the &#39;exists&rsquo; as it has no hope to turn it arround.</p>

<h3>modified benchmark script</h3>
<div class="highlight"><pre><span class="no">TIMES_RUN</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">tag_names</span> <span class="o">=</span> <span class="no">Tag</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s1">&#39;rand()&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>

<span class="no">Benchmark</span><span class="o">.</span><span class="n">bmbm</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
  <span class="n">x</span><span class="o">.</span><span class="n">report</span> <span class="ss">:join</span> <span class="k">do</span>
    <span class="no">TIMES_RUN</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
      <span class="no">Item</span><span class="o">.</span><span class="n">find_by_sql</span><span class="p">(</span><span class="s1">&#39;SELECT `items`.* FROM `items` &#39;</span><span class="p">\</span>
                       <span class="s1">&#39;INNER JOIN `items_tags` ON `items`.`id` = `items_tags`.`item_id` &#39;</span><span class="p">\</span>
                       <span class="s2">&quot;WHERE `items_tags`.`tag_id` in (</span><span class="si">#{</span><span class="no">Tag</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="n">tag_names</span><span class="p">)</span><span class="o">.</span><span class="n">pluck</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">x</span><span class="o">.</span><span class="n">report</span> <span class="ss">:in</span> <span class="k">do</span>
    <span class="no">TIMES_RUN</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
      <span class="no">Item</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s1">&#39;id in (select item_id from items_tags where tag_id in (?))&#39;</span><span class="p">,</span> <span class="no">Tag</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="n">tag_names</span><span class="p">))</span><span class="o">.</span><span class="n">all</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
<h3>result</h3>

<p>Rehearsal &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-
join 206.690000   1.410000 208.100000 (241.762138)
in   184.610000   1.280000 185.890000 (219.442039)
&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash; total: 393.990000sec</p>
<div class="highlight"><pre><span class="w">       </span><span class="vg">user</span><span class="w">     </span><span class="vg">system</span><span class="w">      </span><span class="vg">total</span><span class="w">        </span><span class="vg">real</span>
</pre></div>
<p>join 215.460000   1.650000 217.110000 (253.513529)
in   196.940000   1.510000 198.450000 (235.073522)</p>

<h3>at last</h3>

<p>&#39;in&rsquo; and &#39;join&rsquo; are close. I pick the &#39;in&rsquo; way for cleanner code.</p>
</a>
    
    <div class="hp-c"></div>
  </div>
</div>
  <div class="hp-c"></div>
</div>

<div class="hp-sb">
  <section class="hp-author">
  <header>The author</header>
  <h2>Snow Hellsing</h2>
  Just a stray cat
</section>
  
  <section class="hp-tag_cloud">
  <header>Tags</header>
  <a href="/tags/BBQ.html" class="set-1">BBQ</a> <a href="/tags/beef.html" class="set-1">beef</a> <a href="/tags/benchmark.html" class="set-1">benchmark</a> <a href="/tags/bike.html" class="set-1">bike</a> <a href="/tags/career.html" class="set-1">career</a> <a href="/tags/cat.html" class="set-1">cat</a> <a href="/tags/centos.html" class="set-1">centos</a> <a href="/tags/chicken.html" class="set-1">chicken</a> <a href="/tags/coding.html" class="set-1">coding</a> <a href="/tags/cooking.html" class="set-3">cooking</a> <a href="/tags/css.html" class="set-1">css</a> <a href="/tags/curry.html" class="set-1">curry</a> <a href="/tags/debian.html" class="set-1">debian</a> <a href="/tags/gfw.html" class="set-1">gfw</a> <a href="/tags/honey.html" class="set-1">honey</a> <a href="/tags/lettuce.html" class="set-1">lettuce</a> <a href="/tags/life.html" class="set-5">life</a> <a href="/tags/linux.html" class="set-1">linux</a> <a href="/tags/meat.html" class="set-3">meat</a> <a href="/tags/microwave.html" class="set-1">microwave</a> <a href="/tags/mysql.html" class="set-1">mysql</a> <a href="/tags/pork.html" class="set-1">pork</a> <a href="/tags/rails.html" class="set-1">rails</a> <a href="/tags/sql.html" class="set-1">sql</a> <a href="/tags/tech.html" class="set-3">tech</a> <a href="/tags/ubuntu.html" class="set-1">ubuntu</a> <a href="/tags/xanthoxylum.html" class="set-1">xanthoxylum</a>
</section>
  
  <section class="hp-archive">
    <header><a href="/archive.html">Archive</a></header>
  </section>
  
  <div class="hp-c"></div>
</div>
        <div class="hp-c"></div>
      </div>
    </div>
    
    <footer>Powered by <a href="http://jekyllrb.com/" target="_blank">jekyll</a>, hosting on <a href="http://pages.github.com/" target="_blank">github</a></footer>
  </div>
</body>
</html>
